<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src\Demo\Protocol\Rpc\Client.js</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../../../prettify.css">
    <link rel="stylesheet" href="../../../../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../../../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header high">
    <h1>Code coverage report for <span class="entity">src\Demo\Protocol\Rpc\Client.js</span></h1>
    <h2>
        Statements: <span class="metric">97.73% <small>(43 / 44)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Branches: <span class="metric">66.67% <small>(4 / 6)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Functions: <span class="metric">100% <small>(14 / 14)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Lines: <span class="metric">97.73% <small>(43 / 44)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../../../index.html">All files</a> &#187; <a href="index.html">src/Demo/Protocol/Rpc/</a> &#187; Client.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/**
 * @file RPC客户端工具类
 * @author zhangziqiu@baidu.com
 */
&nbsp;
/* global oojs */
oojs.define({
    name: 'Client',
    namespace: 'Demo.Protocol.Rpc',
    deps: {
        nsHead: 'Demo.Common.Model.NsHead',
        proto: 'Demo.Common.Model.Proto',
        converter: 'Demo.Common.Model.Converter',
        net: require('net')
    },
&nbsp;
    config: {
        // 请求的服务接口
        methodId: 0,
        // 是否启用snappy压缩
        snappy: false,
        // 服务器地址
        serverAddress: '127.0.0.1',
        // 服务器端口
        serverPort: 8124,
        // 请求对象模型
        requestModel: 'Demo.Common.Model.TemplateRequestInfo',
        // 返回对象模型
        responseModel: 'Demo.Common.Model.TemplateResponseInfo',
        // 是否缓存requestInfo, 每次发送请求都对requestInfo序列化十分消耗客户端性能.
        // 开启后, 会缓存第一次调用write函数时传递的requestInfo, 后续再传递的requestInfo将失效.
        isCacheRequestInfo: false
    },
&nbsp;
    /**
     * 动态构造函数
     *
     * @param {Object} config 配置文件,参见Client.config属性
     * @constructor
     */
    Client: function (config) {
        // 设置配置文件
        this.config = this.merge(config, this.config);
        this.config.requestModel = oojs.using(this.config.requestModel);
        this.config.responseModel = oojs.using(this.config.responseModel);
        // 创建promise,初始状态为fullfilled
        this.promise = oojs.promise.resolve(config);
    },
&nbsp;
    /**
     * 将源对象的属性合并到目标对象,同名属性使用源对象的值.
     *
     * @param {Object} source 源对象
     * @param {Object} to 目标对象
     * @return {Object} 合并后的对象引用
     */
    merge: function (source, to) {
        for (var key in source) {
            <span class="missing-if-branch" title="else path not taken" >E</span>if (source.hasOwnProperty(key) &amp;&amp; typeof source[key] !== 'undefined') {
                to[key] = source[key];
            }
&nbsp;
        }
        return to;
    },
&nbsp;
    /**
     * 创建连接
     *
     * @return {Object} 当前对象的this指针
     */
    connect: function () {
        this.promise = this.promise.then(function (config) {
            var socketPromise = oojs.create(oojs.promise);
            this.socket = new this.net.Socket();
            this.socket.connect(config.serverPort, config.serverAddress, function () {
                socketPromise._resolve();
            });
            return socketPromise;
        }.proxy(this));
        return this;
    },
&nbsp;
    /**
     * 发送请求
     *
     * @param {Object} requestInfo 请求对象
     * @return {Object} 返回当前对象的this指针
     */
    write: function (requestInfo) {
        // 写入请求数据
        this.promise = this.promise.then(function () {
            // 返回socketPromise
            var socketPromise = oojs.create(oojs.promise);
            // 首先设置回调函数
            this.socket.on('data', function (data) {
                this.nsHead.processPackage({
                    data: data,
                    socket: this.socket,
                    processFunction: function (data) {
                        socketPromise._resolve(data);
                    }
                });
            }.proxy(this));
            // 写入数据
            var totalBuffer;
            var messageBuffer = this.converter.objToProto(this.config.requestModel, requestInfo).toBuffer();
            var nsHead = this.nsHead.writeNsHead({
                methodId: this.config.methodId,
                snappy: this.config.snappy,
                bodyLength: messageBuffer.length
            });
            totalBuffer = Buffer.concat([
                nsHead,
                messageBuffer
            ]);
            this.socket.write(totalBuffer);
            return socketPromise;
        }.proxy(this));
&nbsp;
        // 处理返回的数据包
        this.promise = this.promise.then(function (data) {
            var nsHead = data.nsHead;
            var bodyBuffer = data.bodyBuffer;
            <span class="missing-if-branch" title="if path not taken" >I</span>if (nsHead.snappy) {
<span class="cstat-no" title="statement not covered" >                bodyBuffer = this.snappy.uncompress(bodyBuffer);</span>
            }
&nbsp;
            var responseInfo = this.converter.byteToProto(this.config.responseModel, bodyBuffer);
            return responseInfo;
        }.proxy(this));
&nbsp;
        return this;
    },
&nbsp;
    /**
     * 收到数据后的处理
     *
     * @param {Function} onFullFill 成功时的回调函数
     * @param {Function} onRejected 失败时的回调函数
     * @return {Object} 返回当前对象的this指针
     */
    then: function (onFullFill, onRejected) {
        this.promise = this.promise.then(onFullFill, onRejected);
        return this;
    },
&nbsp;
    /**
     * 关闭连接
     *
     * @return {Object} 返回当前对象的this指针
     */
    close: function () {
        this.promise = this.promise.then(function () {
            this.socket.destroy();
            this.socket = null;
            return true;
        }.proxy(this));
        return this;
    },
&nbsp;
    /**
     * 异常处理
     *
     * @param {Function} func 异常处理函数
     * @return {Object} 返回当前对象的this指针
     */
    error: function (func) {
        this.promise = this.promise.catch(func);
        return this;
    }
});
&nbsp;</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Oct 27 2015 13:10:40 GMT+0800 (中国标准时间)</div>
</div>
<script src="../../../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../../../sorter.js"></script>
</body>
</html>
